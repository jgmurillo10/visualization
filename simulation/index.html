<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Force Tutorial</title>
  </head>
  <body>
    <h1>Force Tutorial</h1>
    <canvas id="network" width="500" height="500"></canvas>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script type="text/javascript">
      var graph2 = {
        nodes: [
          {
            name: "john",
            age: 36
          },
          {
            name: "alejo",
            age: 23
          },
          {
            name: "juan",
            age: 20
          },
          {
            name: "stephany",
            age: 23
          },
          {
            name: "carlos",
            age: 50
          },
          {
            name: "arnulfo",
            age: 96
          }
        ],
        links: [
          {source: "john", target: "alejo"},
          {source: "john", target: "juan"},
          {source: "arnulfo", target: "carlos"},
          {source: "stephany", target: "juan"},
          {source: "alejo", target: "juan"},
          {source: "arnulfo", target: "john"}
        ]
      }
      var canvas = d3.select("#network"),
      //returns the html or dom element
      ctx = canvas.node().getContext("2d"),
      width = canvas.attr("width"),
      height = canvas.attr("height"),
      r = 3,
      color = d3.scaleOrdinal(d3.schemeCategory20),
      x = d3.scaleOrdinal() .range([20,width-20]),
      simulation = d3.forceSimulation()
                     .force("x",d3.forceX(d=>x(d.party)).strength(0.7))
                     .force("y",d3.forceY(height/2))
                     .force("collide", d3.forceCollide(r+1))
                     .force("charge", d3.forceManyBody()
                                        .strength(-20))
                    //avoid setting x and y attribute to source and target of the links
                     .force("link", d3.forceLink()
                                      .id(function (d) {
                                        return d.name;
                                      }));
      d3.json("VotacionesSenado2017.json", function (err,graph) {
        if (err) throw err;
        simulation
                  .nodes(graph.nodes)
                  .on("tick", update)
                  .force("link")
                    .links(graph.links);
        canvas
            .call(d3.drag()
                .container(canvas.node() )
                .subject(dragsubject)
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));
        function update() {
          //clear the whole canvas
           ctx.clearRect(0,0, width, height);

           ctx.beginPath();
           ctx.globalAlpha = 0.1;
           ctx.strokeStyle = "#aaa";
           graph.links.forEach(drawLink);
           ctx.stroke ();


           ctx.globalAlpha = 1.0;
           graph.nodes.forEach(drawNode);

        }
        function dragsubject() {
           return simulation.find(d3.event.x, d3.event.y);
         }

      })



      function drawNode(d) {
        ctx.beginPath();
        ctx.fillStyle = color(d.party);
        ctx.moveTo(d.x,d.y);
        ctx.arc(d.x,d.y, r,0,2*Math.PI)
        ctx.fill();
      }
      function drawLink(d) {
        ctx.moveTo(d.source.x,d.source.y);
        ctx.lineTo(d.target.x,d.target.y);
      }
      function dragstarted() {
        if (!d3.event.active) simulation.alphaTarget(0.3).restart();
        d3.event.subject.fx = d3.event.subject.x;
        d3.event.subject.fy = d3.event.subject.y;
        console.log(d3.event.subject);
      }

      function dragged() {
        d3.event.subject.fx = d3.event.x;
        d3.event.subject.fy = d3.event.y;
      }

      function dragended() {
        if (!d3.event.active) simulation.alphaTarget(0);
        d3.event.subject.fx = null;
        d3.event.subject.fy = null;
      }
      //No more update manually
      // update();
    </script>
  </body>
</html>
